function decipher(s, key) {
  try {
    var decrypted = CryptoJS.AES.decrypt(s, key).toString(CryptoJS.enc.Utf8);
    return (decrypted.length > 0) ? decrypted : null;
  } catch(err) {
    return null;
  }
}

function get_payload_key(key) {
  <% cipher.keys.each do |avail_key| %>
    <% salt  = SecureRandom.hex(16) %>
    <% token = SecureRandom.hex(16) %>
    var token     = '<%= token %>';
    var secret    = '<%= cipher.encrypt(token, avail_key, salt) %>';
    var decrypted = decipher(secret, key + '<%= salt %>');
    if(token == decrypted)
      return decipher('<%= cipher.encrypt(cipher.payload_key, avail_key, salt) %>', key + '<%= salt %>');
  <% end %>
  return null;
}

function decode(key) {
  $("#decoding-info").html("Decoding...");

  var decrypted = decipher('<%= data %>', key);
  if(!decrypted)
    return false;

  var json = JSON.parse(decrypted);

  var html = HandlebarsTemplates['js/content'](json);
  $("#content").html(html);

  update_language_graph(json['skills']['languages']);

  document.title = json['title'];

  return true;
}

function hide_info() {
  $('#decoding-info').animate({ 'opacity': 0 }, 200, 'ease-out', function() {
    $('#decoding-overlay').hide();
  });
}

function no_access() {
  $("#decoding-info").html("Decoding failure. Please provide password using fragment identifier.");
}

Zepto(function($) {
  Handlebars.registerHelper('gravatar', function(email) {
      return 'http://www.gravatar.com/avatar/' + CryptoJS.MD5(email) + '.jpg?s=140';
  });

  var key = window.location.hash.substr(1);
  if(key) {
    var payload_key = get_payload_key(key);
    if(!payload_key)
      no_access();

    if(!decode(payload_key))
      return no_access();

    hide_info();
  } else {
    <% if env == :debug %>
      var decode_button = Zepto('<button>');

      decode_button.attr('id','decode-button');
      decode_button.text('Decode!');
      decode_button.on('click', function() {
        if(!decode('<%= cipher.payload_key %>'))
          console.log("Decoding failed.");

        hide_info();
      });

      $('#decoding-info').append(decode_button);
    <% else %>
      no_access();
    <% end %>
  }
});
